(()=>{"use strict";(()=>{const e=["png","jpeg","jpg"];let t=document.querySelector(".ad-form__field input[type=file]"),n=document.querySelector(".ad-form-header__preview img"),o=document.querySelector(".ad-form__upload input[type=file]"),r=document.querySelector(".ad-form__photo");t.addEventListener("change",(function(){let o=t.files[0],r=o.name.toLowerCase();if(e.some((function(e){return r.endsWith(e)}))){let e=new FileReader;e.addEventListener("load",(function(){n.src=e.result})),e.readAsDataURL(o)}})),o.addEventListener("change",(function(){let t=o.files[0],n=t.name.toLowerCase();if(e.some((function(e){return n.endsWith(e)}))){let e=new FileReader;e.addEventListener("load",(function(){r.style.backgroundImage=`url(${e.result})`})),e.readAsDataURL(t)}}))})(),window.constants={BUTTON_ENTER:"Enter",BUTTON_ESC:"Escape",LEFT_MOUSE_BTN:0},(()=>{const e="GET",t="POST";window.backend={load(t,n){const o=new XMLHttpRequest;o.responseType="json",o.addEventListener("load",(function(){200===o.status?t(o.response):n(`Ошибка загрузки данных: ${o.status} ${o.statusText}`)})),o.addEventListener("error",(function(){n("Ошибка соединения")})),o.addEventListener("timeout",(function(){n(`Запрос не успел выполниться за ${o.timeout} мс`)})),o.timeout=1e3,o.open(e,"https://21.javascript.pages.academy/keksobooking/data"),o.send()},send(e,n,o){const r=new XMLHttpRequest;r.responseType="json",r.addEventListener("load",(function(){200===r.status?n():o(`Ошибка отправки данных: ${r.status} ${r.statusText}`)})),r.addEventListener("error",(function(){o("Ошибка соединения")})),r.addEventListener("timeout",(function(){o(`Запрос не успел выполниться за ${r.timeout} мс`)})),r.timeout=1e3,r.open(t,"https://21.javascript.pages.academy/keksobooking"),r.send(e)}}})(),(()=>{const e=document.querySelector("#card").content.querySelector(".map__card"),t=document.querySelector(".map__filters-container"),n={Palace:"Дворец",Flat:"Квартира",House:"Дом",Bungalow:"Бунгало "};window.card={generateCardTemplate(o){const r=document.createDocumentFragment();r.appendChild(function(t){const o=e.cloneNode(!0),r=o.querySelector(".popup__title"),i=o.querySelector(".popup__text--address"),c=o.querySelector(".popup__text--price"),a=o.querySelector(".popup__type"),d=o.querySelector(".popup__text--capacity"),l=o.querySelector(".popup__text--time"),u=o.querySelector(".popup__features"),s=u.querySelectorAll(".popup__feature"),p=o.querySelector(".popup__description"),f=o.querySelector(".popup__photos"),m=f.querySelector(".popup__photo"),y=o.querySelector(".popup__avatar");return r.textContent=t.offer.title,i.textContent=t.offer.address,c.textContent=t.offer.price+"₽/ночь",a.textContent=n[t.offer.type],d.textContent=`${t.offer.rooms} комнаты для ${t.offer.guests} гостей`,l.textContent=`Заезд после ${t.offer.checkin}, выезд до ${t.offer.checkout}`,p.textContent=t.offer.description,y.src=t.author.avatar,s.forEach((e=>{u.removeChild(e)})),t.offer.features.forEach((e=>{let t=document.createElement("li");t.classList.add("popup__feature"),t.classList.add("popup__feature--"+e),u.appendChild(t)})),f.removeChild(m),t.offer.photos.forEach((e=>{let t=m;t.src=e,f.appendChild(t)})),o}(o)),t.before(r)}}})(),(()=>{const e=document.querySelector(".map"),t=function(e){e.key===window.constants.BUTTON_ESC&&(e.preventDefault(),window.popup.closePopup())};window.popup={openPopup(n){const o=e.querySelector(".popup");o&&e.removeChild(o),window.card.generateCardTemplate(n),document.addEventListener("keydown",t),e.querySelector(".popup__close").addEventListener("click",this.closePopup)},closePopup(){const n=e.querySelector(".popup");e.removeChild(n),document.removeEventListener("keydown",t)}}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin"),t=document.querySelector(".map"),n=t.querySelector(".map__pins"),o=function(t){const n=e.cloneNode(!0),o=n.querySelector("img");return o.src=t.author.avatar,o.alt=t.offer.description,n.style.left=t.location.x+o.width/2+"px",n.style.top=t.location.y+o.height+"px",n.addEventListener("click",(function(){window.popup.openPopup(t)})),n.addEventListener("keydown",(function(e){e.key===window.constants.BUTTON_ENTER&&(e.preventDefault(),window.popup.openPopup(t))})),n};window.pin={generatePinTemplate(e){const r=t.querySelectorAll(".map__pin:not(.map__pin--main)");r&&r.forEach((e=>n.removeChild(e)));const i=document.createDocumentFragment();let c=5<e.length?5:e.length;for(let t=0;t<c;t++)i.appendChild(o(e[t]));n.appendChild(i)}}})(),window.debounce=function(e){let t=null;return function(...n){t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...n)}),500)}},(()=>{const e=document.querySelector(".map"),t={low:{min:0,max:1e4},middle:{min:1e4,max:5e4},high:{min:5e4,max:1e6}},n="any",o={"Wi-Fi":"wifi","Посудомоечная машина":"dishwasher",Парковка:"parking","Стиральная машина":"washer",Лифт:"elevator",Кондиционер:"conditioner"};let r=[];window.filter={byType(o,i){!function(){const t=e.querySelector(".popup");t&&e.removeChild(t)}();let c=[];var a,d;a=o,c=(d=i.type)!==n?a.filter((e=>e.offer.type===d)):a,c=function(e,o){return o!==n?e.filter((e=>e.offer.price>=t[o].min&&e.offer.price<=t[o].max)):e}(c,i.price),c=function(e,t){return t!==n?e.filter((e=>parseInt(e.offer.rooms,10)===parseInt(t,10))):e}(c,i.rooms),c=function(e,t){return t!==n?e.filter((e=>parseInt(e.offer.guests,10)===parseInt(t,10))):e}(c,i.guests),c=function(e){return e.filter((e=>function(e){let t=0,n=!1;return e.forEach((e=>{-1!==r.indexOf(e)&&(t+=1)})),t===r.length&&(n=!0),n}(e.offer.features)))}(c),window.pin.generatePinTemplate(c)},byFeature(e){!function(e,t){let n="";if(n=e.includes(t),n){let n=r.indexOf(t);e.splice(n,1)}else e.push(t)}(r,o[e])}}})(),(()=>{const e=["Palace","Flat","House","Bungalow"],t=["0","1000","5000","10000"],n=document.querySelector(".map"),o=n.querySelector(".map__filters"),r=document.querySelector(".ad-form"),i=r.querySelector("#capacity"),c=r.querySelectorAll("#capacity option"),a=r.querySelector("#price"),d=r.querySelector("#address"),l=document.querySelector("main"),u=r.querySelector(".ad-form__reset"),s=n.querySelector(".map__pin--main"),p=o.querySelector("#housing-type"),f=o.querySelector("#housing-price"),m=o.querySelector("#housing-rooms"),y=o.querySelector("#housing-guests"),w=document.querySelectorAll(".map__feature");d.value=`${Math.floor(parseInt(s.style.left,10)+s.clientWidth/2)}, ${Math.floor(parseInt(s.style.top,10)+s.clientHeight/2)}`,u.addEventListener("click",(function(){r.reset()}));const h=function(e){for(let e=i.length-1;e>=0;e--)i.removeChild(i[e]);switch(e){case"1":i.appendChild(c[2]);break;case"2":i.appendChild(c[1]),i.appendChild(c[2]);break;case"3":i.appendChild(c[0]),i.appendChild(c[1]),i.appendChild(c[2]);break;default:i.appendChild(c[3])}},v=r.querySelector("#room_number");v.addEventListener("change",(function(e){h(e.target.value)}));const _=function(n){switch(n){case e[0].toLowerCase():a.setAttribute("min",t[3]),a.setAttribute("placeholder",t[3]);break;case e[1].toLowerCase():a.setAttribute("min",t[1]),a.setAttribute("placeholder",t[1]);break;case e[2].toLowerCase():a.setAttribute("min",t[2]),a.setAttribute("placeholder",t[2]);break;default:a.setAttribute("min",t[0]),a.setAttribute("placeholder",t[0])}},g=r.querySelector("#type");g.addEventListener("change",(function(e){_(e.target.value)}));const S=r.querySelector("#timein");S.addEventListener("change",(function(e){for(let t of q.children)e.target.value===t.value&&(q.value=t.value)}));const q=r.querySelector("#timeout");q.addEventListener("change",(function(e){for(let t of S.children)e.target.value===t.value&&(S.value=t.value)}));let E=[];const b=function(e){E=e,window.pin.generatePinTemplate(e)};let L={type:"any",price:"any",rooms:"any",guests:"any"};p.addEventListener("change",(function(e){L.type=e.target.value,window.debounce(window.filter.byType(E,L))})),f.addEventListener("change",(function(e){L.price=e.target.value,window.debounce(window.filter.byType(E,L))})),m.addEventListener("change",(function(e){L.rooms=e.target.value,window.debounce(window.filter.byType(E,L))})),y.addEventListener("change",(function(e){L.guests=e.target.value,window.debounce(window.filter.byType(E,L))})),w.forEach((e=>{e.addEventListener("click",(function(e){window.filter.byFeature(e.target.textContent),window.debounce(window.filter.byType(E,L))}))}));const C=function(e){let t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="15px",t.textContent=e,n.insertAdjacentElement("afterbegin",t)},T=function(){window.utils.setDisabledPage();const e=document.querySelector("#success").content.cloneNode(!0);document.addEventListener("click",(function(){P()}));const t=document.createDocumentFragment();t.appendChild(e),l.appendChild(t),document.addEventListener("keydown",A)},k=function(){const e=document.querySelector("#error").content.cloneNode(!0);e.querySelector(".error__button").addEventListener("click",(function(){D()})),document.addEventListener("click",(function(){D()}));const t=document.createDocumentFragment();t.appendChild(e),l.appendChild(t),document.addEventListener("keydown",x)};r.addEventListener("submit",(function(e){e.preventDefault(),d.removeAttribute("disabled"),window.backend.send(new FormData(r),T,k)}));const x=function(e){e.key===window.constants.BUTTON_ESC&&D()},A=function(e){e.key===window.constants.BUTTON_ESC&&P()},D=function(){const e=document.querySelector(".error");l.removeChild(e),document.removeEventListener("keydown",x)},P=function(){const e=document.querySelector(".success");l.removeChild(e),document.removeEventListener("keydown",A)};window.form={pageActived(){n.classList.remove("map--faded"),r.classList.remove("ad-form--disabled"),h(v.value),_(g.value),window.utils.removeDisabled(r.children),window.utils.removeDisabled(o.children),d.setAttribute("disabled","disabled"),window.backend.load(b,C)}}})(),(()=>{const e=function(e){return Math.floor(Math.random()*e.length)};window.utils={getRandomFromRange:(e,t)=>Math.floor(Math.random()*(t-e)+e),getRandomIndex:t=>t[e(t)],getRandomLengthArr(t){let n=e(t),o=[];for(let e=0;e<n;e++)o.push(t[e]);return o},setDisabled(e){for(let t of e)t.setAttribute("disabled","disabled")},removeDisabled(e){for(let t of e)t.removeAttribute("disabled")},setDisabledPage(){const e=document.querySelector(".map"),t=document.querySelector(".ad-form"),n=e.querySelector(".map__filters"),o=e.querySelectorAll(".map__pin:not(.map__pin--main)"),r=e.querySelector(".map__pins");e.classList.add("map--faded"),t.classList.add("ad-form--disabled"),window.utils.setDisabled(t.children),window.utils.setDisabled(n.children),t.reset(),window.utils.isPageActiveted=!1,o.forEach((e=>r.removeChild(e)))},isPageActiveted:!1}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pin--main"),n=document.querySelector("#address"),o=e.clientWidth,r=function(){n.value=`${Math.floor(parseInt(t.style.left,10)+t.clientWidth/2)}, ${Math.floor(parseInt(t.style.top,10)+t.clientHeight-87)}`};t.addEventListener("mousedown",(function(e){e.button!==window.constants.LEFT_MOUSE_BTN||window.utils.isPageActiveted||(window.form.pageActived(),window.utils.isPageActiveted=!0);let n={x:e.clientX,y:e.clientY};const i=function(e){e.preventDefault();let i=n.x-e.clientX,c=n.y-e.clientY;n={x:e.clientX,y:e.clientY};let a=parseInt(t.style.top,10)>43&&parseInt(t.style.top,10)<543,d=parseInt(t.style.left,10)>155&&parseInt(t.style.left,10)<o-65,l=e.clientX>220&&e.clientX<o,u=e.clientY>130&&e.clientY<630;(a&&d||l&&u)&&(t.style.left=t.offsetLeft-i+"px",t.style.top=t.offsetTop-c+"px"),r()},c=function(e){e.preventDefault(),r(),document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",c)};document.addEventListener("mousemove",i),document.addEventListener("mouseup",c)})),t.addEventListener("keydown",(function(e){e.key!==window.constants.BUTTON_ENTER||window.utils.isPageActiveted||(window.form.pageActived(),window.utils.isPageActiveted=!0)}))})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".ad-form"),n=e.querySelector(".map__filters");window.utils.setDisabled(n.children),window.utils.setDisabled(t.children)})()})();