(()=>{"use strict";(()=>{const e=["png","jpeg","jpg"];let t,n=document.querySelector(".ad-form__field input[type=file]"),o=document.querySelector(".ad-form-header__preview img"),r=document.querySelector(".ad-form__upload input[type=file]"),i=document.querySelector(".ad-form__photo");n.addEventListener("change",(()=>{let r=n.files[0],i=r.name.toLowerCase();e.some((function(e){return i.endsWith(e)}))&&(t=new FileReader,t.addEventListener("load",(()=>{o.src=t.result})),t.readAsDataURL(r))})),r.addEventListener("change",(()=>{let n=r.files[0],o=n.name.toLowerCase();e.some((function(e){return o.endsWith(e)}))&&(t=new FileReader,t.addEventListener("load",(()=>{i.style.backgroundImage=`url(${t.result})`})),t.readAsDataURL(n))}))})(),window.constants={BUTTON_ENTER:"Enter",BUTTON_ESC:"Escape",LEFT_MOUSE_BTN:0},(()=>{const e="GET",t="POST";let n;window.backend={load(t,o){n=new XMLHttpRequest,n.responseType="json",n.addEventListener("load",(function(){200===n.status?t(n.response):o(`Ошибка загрузки данных: ${n.status} ${n.statusText}`)})),n.addEventListener("error",(function(){o("Ошибка соединения")})),n.addEventListener("timeout",(function(){o(`Запрос не успел выполниться за ${n.timeout} мс`)})),n.timeout=1e3,n.open(e,"https://21.javascript.pages.academy/keksobooking/data"),n.send()},send(e,o,r){n=new XMLHttpRequest,n.addEventListener("load",(function(){200===n.status?o():r(`Ошибка отправки данных: ${n.status} ${n.statusText}`)})),n.addEventListener("error",(function(){r("Ошибка соединения")})),n.addEventListener("timeout",(function(){r(`Запрос не успел выполниться за ${n.timeout} мс`)})),n.timeout=1e3,n.open(t,"https://21.javascript.pages.academy/keksobooking"),n.send(e)}}})(),(()=>{let e=document.querySelector("#card").content.querySelector(".map__card");const t=document.querySelector(".map__filters-container"),n={Palace:"Дворец",Flat:"Квартира",House:"Дом",Bungalow:"Бунгало "};window.card={generateTemplate(o){const r=document.createDocumentFragment();r.appendChild(function(t){const o=e.cloneNode(!0);let r=o.querySelector(".popup__title"),i=o.querySelector(".popup__text--address"),a=o.querySelector(".popup__text--price"),c=o.querySelector(".popup__type"),l=o.querySelector(".popup__text--capacity"),d=o.querySelector(".popup__text--time"),s=o.querySelector(".popup__features"),u=s.querySelectorAll(".popup__feature"),p=o.querySelector(".popup__description"),m=o.querySelector(".popup__photos"),f=m.querySelector(".popup__photo"),y=o.querySelector(".popup__avatar");return r.textContent=t.offer.title,i.textContent=t.offer.address,a.textContent=t.offer.price+"₽/ночь",c.textContent=n[t.offer.type],l.textContent=`${t.offer.rooms} комнаты для ${t.offer.guests} гостей`,d.textContent=`Заезд после ${t.offer.checkin}, выезд до ${t.offer.checkout}`,p.textContent=t.offer.description,y.src=t.author.avatar,u.forEach((e=>{s.removeChild(e)})),t.offer.features.forEach((e=>{let t=document.createElement("li");t.classList.add("popup__feature"),t.classList.add("popup__feature--"+e),s.appendChild(t)})),m.removeChild(f),t.offer.photos.forEach((e=>{let t=f;t.src=e,m.appendChild(t)})),o}(o)),t.before(r)}}})(),(()=>{let e=document.querySelector(".map");const t=e=>{e.key===window.constants.BUTTON_ESC&&(e.preventDefault(),window.popup.close())};window.popup={open(n){let o=e.querySelector(".popup");o&&e.removeChild(o),window.card.generateTemplate(n),document.addEventListener("keydown",t),e.querySelector(".popup__close").addEventListener("click",this.close)},close(){let n=e.querySelector(".popup");e.removeChild(n),document.removeEventListener("keydown",t)}}})(),(()=>{let e=document.querySelector("#pin").content.querySelector(".map__pin"),t=document.querySelector(".map"),n=t.querySelector(".map__pins");const o=function(n){const o=e.cloneNode(!0);let r=o.querySelector("img");return r.src=n.author.avatar,r.alt=n.offer.description,o.style.left=n.location.x-25+"px",o.style.top=n.location.y-70+"px",o.addEventListener("click",(function(e){t.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.classList.contains("map__pin--active")&&e.classList.remove("map__pin--active")})),e.currentTarget.classList.add("map__pin--active"),window.popup.open(n)})),o.addEventListener("keydown",(function(e){e.key===window.constants.BUTTON_ENTER&&(e.preventDefault(),window.popup.open(n))})),o};window.pin={generateTemplate(e){const r=document.createDocumentFragment();let i=t.querySelectorAll(".map__pin:not(.map__pin--main)");i&&i.forEach((e=>n.removeChild(e)));let a=5<e.length?5:e.length;for(let t=0;t<a;t++)r.appendChild(o(e[t]));n.appendChild(r)}}})(),window.debounce=function(e){let t=null;return function(...n){t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...n)}),500)}},(()=>{const e="any",t={"Wi-Fi":"wifi","Посудомоечная машина":"dishwasher",Парковка:"parking","Стиральная машина":"washer",Лифт:"elevator",Кондиционер:"conditioner"},n={low:{min:0,max:1e4},middle:{min:1e4,max:5e4},high:{min:5e4,max:1e7}};let o=document.querySelector(".map");let r=[];window.filter={byType(t,i){(()=>{const e=o.querySelector(".popup");e&&o.removeChild(e)})();let a=[];var c,l;c=t,a=(l=i.type)!==e?c.filter((e=>e.offer.type===l)):c,a=function(t,o){return o!==e?t.filter((e=>e.offer.price>=n[o].min&&e.offer.price<=n[o].max)):t}(a,i.price),a=function(t,n){return n!==e?t.filter((e=>parseInt(e.offer.rooms,10)===parseInt(n,10))):t}(a,i.rooms),a=function(t,n){return n!==e?t.filter((e=>parseInt(e.offer.guests,10)===parseInt(n,10))):t}(a,i.guests),a=function(e){return e.filter((e=>function(e){let t=0,n=!1;return e.forEach((e=>{-1!==r.indexOf(e)&&(t+=1)})),t===r.length&&(n=!0),n}(e.offer.features)))}(a),window.pin.generateTemplate(a)},byFeature(e){!function(e,t){let n="";if(n=e.includes(t),n){let n=r.indexOf(t);e.splice(n,1)}else e.push(t)}(r,t[e])}}})(),(()=>{const e=["Palace","Flat","House","Bungalow"],t=["0","1000","5000","10000"];let n=document.querySelector(".map"),o=n.querySelector(".map__pin--main");const r=o.style.left,i=o.style.top;let a=n.querySelector(".map__filters"),c=document.querySelector(".ad-form"),l=c.querySelector("#capacity"),d=c.querySelectorAll("#capacity option"),s=c.querySelector("#price"),u=c.querySelector("#address"),p=document.querySelector("main"),m=c.querySelector(".ad-form__reset"),f=a.querySelector("#housing-type"),y=a.querySelector("#housing-price"),w=a.querySelector("#housing-rooms"),v=a.querySelector("#housing-guests"),h=document.querySelectorAll(".map__feature"),_=document.querySelectorAll(".map__checkbox"),g=document.querySelector(".ad-form-header__preview img"),S=document.querySelector(".ad-form__photo");const q=function(){window.utils.setDisabledPage(),o.style.left=r,o.style.top=i,f.value="any",y.value="any",w.value="any",v.value="any",_.forEach((e=>{e.checked=!1})),D={type:"any",price:"any",rooms:"any",guests:"any"},g.src="img/muffin-grey.svg",S.style.backgroundImage="",u.value=`${Math.floor(parseInt(o.style.left,10)+o.clientWidth/2)}, ${Math.floor(parseInt(o.style.top,10)+o.clientHeight-87)}`};m.addEventListener("click",q);const E=function(e){for(let e=l.length-1;e>=0;e--)l.removeChild(l[e]);switch(e){case"1":l.appendChild(d[2]);break;case"2":l.appendChild(d[1]),l.appendChild(d[2]);break;case"3":l.appendChild(d[0]),l.appendChild(d[1]),l.appendChild(d[2]);break;default:l.appendChild(d[3])}};let b=c.querySelector("#room_number");b.addEventListener("change",(function(e){E(e.target.value)}));const L=function(n){switch(n){case e[0].toLowerCase():s.setAttribute("min",t[3]),s.setAttribute("placeholder",t[3]);break;case e[1].toLowerCase():s.setAttribute("min",t[1]),s.setAttribute("placeholder",t[1]);break;case e[2].toLowerCase():s.setAttribute("min",t[2]),s.setAttribute("placeholder",t[2]);break;default:s.setAttribute("min",t[0]),s.setAttribute("placeholder",t[0])}};let C=c.querySelector("#type");C.addEventListener("change",(function(e){L(e.target.value)}));let k=c.querySelector("#timein");k.addEventListener("change",(function(e){for(let t of T.children)e.target.value===t.value&&(T.value=t.value)}));let T=c.querySelector("#timeout");T.addEventListener("change",(function(e){for(let t of k.children)e.target.value===t.value&&(k.value=t.value)}));let x=[];const A=function(e){n.classList.remove("map--faded"),c.classList.remove("ad-form--disabled"),E(b.value),L(C.value),window.utils.removeDisabled(c.children),window.utils.removeDisabled(a.children),u.setAttribute("disabled","disabled"),x=e,window.pin.generateTemplate(e)};let D={type:"any",price:"any",rooms:"any",guests:"any"};f.addEventListener("change",(function(e){D.type=e.target.value,window.debounce(window.filter.byType(x,D))})),y.addEventListener("change",(function(e){D.price=e.target.value,window.debounce(window.filter.byType(x,D))})),w.addEventListener("change",(function(e){D.rooms=e.target.value,window.debounce(window.filter.byType(x,D))})),v.addEventListener("change",(function(e){D.guests=e.target.value,window.debounce(window.filter.byType(x,D))})),h.forEach((e=>{e.addEventListener("click",(function(e){window.filter.byFeature(e.target.textContent),window.debounce(window.filter.byType(x,D))}))}));const N=function(e){let t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="15px",t.textContent=e,n.insertAdjacentElement("afterbegin",t)},$=function(){q();const e=document.querySelector("#success").content.cloneNode(!0);document.addEventListener("click",P);const t=document.createDocumentFragment();t.appendChild(e),p.appendChild(t),document.addEventListener("keydown",I)},F=function(){const e=document.querySelector("#error").content.cloneNode(!0);e.querySelector(".error__button").addEventListener("click",(function(){O()})),document.addEventListener("click",(function(){O()}));const t=document.createDocumentFragment();t.appendChild(e),p.appendChild(t),document.addEventListener("keydown",B)};c.addEventListener("submit",(function(e){e.preventDefault(),window.backend.send(new FormData(c),$,F)}));const B=function(e){e.key===window.constants.BUTTON_ESC&&O()},I=function(e){e.key===window.constants.BUTTON_ESC&&P()},O=function(){let e=document.querySelector(".error");p.removeChild(e),document.removeEventListener("keydown",B)},P=function(){let e=document.querySelector(".success");p.removeChild(e),document.removeEventListener("keydown",I),document.removeEventListener("click",P)};window.form={pageActived(){window.backend.load(A,N)}}})(),window.utils={setDisabled(e){for(let t of e)t.setAttribute("disabled","disabled")},removeDisabled(e){for(let t of e)t.removeAttribute("disabled")},setDisabledPage(){let e=document.querySelector(".map"),t=document.querySelector(".ad-form"),n=e.querySelector(".map__filters"),o=e.querySelectorAll(".map__pin:not(.map__pin--main)"),r=e.querySelector(".map__pins");e.classList.add("map--faded"),t.classList.add("ad-form--disabled"),window.utils.setDisabled(t.children),window.utils.setDisabled(n.children),t.reset(),window.utils.isPageActiveted=!1,o.forEach((e=>r.removeChild(e)))},isPageActiveted:!1},(()=>{let e=document.querySelector(".map"),t=e.querySelector(".map__pin--main"),n=document.querySelector("#address");const o=function(){n.value=`${Math.floor(parseInt(t.style.left,10)+t.clientWidth/2)}, ${Math.floor(parseInt(t.style.top,10)+t.clientHeight-87)}`};t.addEventListener("mousedown",(function(n){if(n.button===window.constants.LEFT_MOUSE_BTN){window.utils.isPageActiveted||(window.form.pageActived(),window.utils.isPageActiveted=!0);let r={x:n.clientX,y:n.clientY};const i=function(n){n.preventDefault();let i=r.x-n.clientX,a=r.y-n.clientY;r={x:n.clientX,y:n.clientY};let c=parseInt(t.style.left,10),l=parseInt(t.style.top,10),d=e.getBoundingClientRect().x+32.5,s=1167.5;(n.clientX>d||c>0)&&(n.clientX<s||c<s)&&(t.style.left=t.offsetLeft-i+"px"),(n.clientY>130||l>130)&&(n.clientY<630-window.scrollY||l<630-window.scrollY)&&(t.style.top=t.offsetTop-a+"px"),o()},a=function(e){e.preventDefault(),o(),document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",a)};document.addEventListener("mousemove",i),document.addEventListener("mouseup",a)}})),t.addEventListener("keydown",(function(e){e.key!==window.constants.BUTTON_ENTER||window.utils.isPageActiveted||(window.form.pageActived(),window.utils.isPageActiveted=!0)}))})(),(()=>{let e=document.querySelector(".ad-form"),t=document.querySelector(".map__filters");window.utils.setDisabled(t.children),window.utils.setDisabled(e.children)})()})();